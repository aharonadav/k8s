pipeline {
    environment {
        ECR = '553686865554.dkr.ecr.eu-west-1.amazonaws.com/k8s_demo'
    }    
    agent {
     kubernetes {
      //cloud 'kubernetes'
      yamlFile 'KubernetesPod.yaml'
    }
  }
  stages {
      stage('Run shell') {
          steps {
            sh 'curl -LO "https://storage.googleapis.com/kubernetes-release/release/v1.20.5/bin/linux/amd64/kubectl"'  
            sh 'chmod u+x ./kubectl'  
            sh './kubectl get pods -n default'
          }  
      }
      stage('pull code') {
          steps {
              git branch: 'main',
                  credentialsId: 'aharon-github',
                  url: 'https://github.com/aharonadav/k8s.git'
              sh 'ls -lat'
          }
      }
      stage('Login to ECR') {
        steps {
          script {
              container('awscli-jnlp') {
                withAWS(credentials: 'ecr:eu-west-1:AWS', region: 'eu-west-1') {
                  sh 'aws ecr get-login-password --region eu-west-1'
                  ecrLogin()
                }
              }
          }
        }
      }
      stage('Push to ECR')
        steps{
            script {
                container('docker') {
                  script {
                      withAWS(credentials: 'ecr:eu-west-1:AWS', region: 'eu-west-1') {
                        sh 'docker build -t app1 .'
                        sh "docker image tag app1:latest ${env.ECR}:${BUILD_NUMBER}"
                        sh "docker push ${env.ECR}:${BUILD_NUMBER}"
                      }
                  }
                }
            }
        }
      }
   }
}